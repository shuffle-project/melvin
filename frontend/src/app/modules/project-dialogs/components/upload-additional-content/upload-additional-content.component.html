<div class="wrapper">
  @if (isOwner$ | ngrxPush) {
  <h2 i18n="@@uploadAdditionalMediaTitle">Upload additional media files</h2>

  <form class="upload-form" [formGroup]="formGroup">
    <div class="first-row">
      <div
        class="upload-wrapper"
        [ngClass]="{
          error:
            formGroup.get('file')?.hasError('required') &&
            formGroup.get('file')?.touched
        }"
      >
        <input
          #fileUpload
          formControlName="file"
          type="file"
          name="file"
          single
          accept="video/*"
          (change)="onFileChange($event)"
          aria-describedby="file-error-info"
        />
        <div class="file-error-wrapper" aria-live="polite">
          @if( formGroup.get('file')?.hasError('required') &&
          formGroup.get('file')?.touched ){
          <p
            id="file-error-info"
            class="file-error"
            i18n="@@uploadAdditionalMediaVideoFileErrorRequired"
          >
            A video file is required
          </p>
          }
        </div>
      </div>

      <mat-form-field class="category">
        <mat-label i18n="@@uploadAdditionalMediaVideoCategoryLabel"
          >Choose a category</mat-label
        >
        <mat-select formControlName="category">
          <!-- TODO media category i18n -->
          @for (selectableCategory of selectableMediaCategories; track $index) {
          <mat-option [value]="selectableCategory">{{
            selectableCategory | mediaCategory
          }}</mat-option>
          }
        </mat-select>

        @if( formGroup.get('category')?.hasError('required')){
        <mat-error i18n="@@uploadAdditionalMediaVideoCategoryErrorRequired">
          Category is required
        </mat-error>
        }
      </mat-form-field>
    </div>
    <div class="second-row">
      <div></div>
      <button
        (click)="onClickSubmit()"
        mat-flat-button
        i18n="@@uploadAdditionalMediaUploadButton"
      >
        <mat-icon svgIcon="upload" />
        Upload
      </button>
    </div>
  </form>
  } @if (fileUploads.length > 0) {
  <div>
    <h3 i18n="@@uploadAdditionalMediaUploadingHeader">Uploading</h3>
    <ul class="upload-list">
      @for (fileUpload of fileUploads; track fileUpload) {
      <li>
        {{ fileUpload.name }}
        @if (fileUpload.loaded && fileUpload.totalSize) {
        <mat-progress-bar
          mode="determinate"
          [value]="(fileUpload.loaded / fileUpload.totalSize) * 100"
        ></mat-progress-bar>
        }
        <!-- {{ (fileUpload.loaded / fileUpload.totalSize) * 100 }}% -->
        <button mat-icon-button (click)="onCancelUpload(fileUpload)">
          <mat-icon svgIcon="close"></mat-icon>
        </button>
      </li>
      }
    </ul>
  </div>
  }
  <ng-container *ngrxLet="project$ as project">
    <ng-container *ngrxLet="media$ as media">
      @if ( project && media) {
      <div class="uploaded-media-wrapper">
        <h2 i18n="@@uploadAdditionalMediaListHeader">Uploaded media</h2>
      </div>

      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        (matSortChange)="announceSortChange($event)"
      >
        <ng-container matColumnDef="category">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            sortActionDescription="Sort by category"
            i18n="@@uploadAdditionalMediaTableLanguageHeader"
          >
            Category
          </th>
          <td mat-cell *matCellDef="let element">
            {{ element.category }}
          </td>
        </ng-container>

        <ng-container matColumnDef="title">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            sortActionDescription="Sort by title"
            i18n="@@uploadAdditionalMediaTableTitleHeader"
          >
            Title
          </th>
          <td mat-cell *matCellDef="let element">{{ element.title }}</td>
        </ng-container>

        <ng-container matColumnDef="createdAt">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            sortActionDescription="Sort by date of creation"
            i18n="@@uploadAdditionalMediaTableLastEditHeader"
          >
            Created at
          </th>
          <td mat-cell *matCellDef="let element">
            {{ element.createdAt | formatDate }}
          </td>
        </ng-container>

        <ng-container matColumnDef="more">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            sortActionDescription="Sort by more"
            i18n="@@uploadAdditionalMediaTableMoreHeader"
          >
            More
          </th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              aria-label="more"
              [matMenuTriggerFor]="mediaMoreMenu"
              [matMenuTriggerData]="{ media: element }"
            >
              <mat-icon svgIcon="more" />
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      }
    </ng-container>
  </ng-container>
</div>

<mat-menu #mediaMoreMenu="matMenu" class="dense">
  <ng-template matMenuContent let-media="media">
    @if (project$ | ngrxPush; as project) {
    <button
      (click)="onDownloadMedia(project, media)"
      mat-menu-item
      i18n="@@uploadAdditionalMediaDownloadButtonLabel"
    >
      <mat-icon svgIcon="download" />
      Download
    </button>
    } @if ((isOwner$ | ngrxPush) && media.category !== 'main' && project$ |
    ngrxPush; as project) {
    <div>
      <mat-divider />
      <button
        (click)="onDeleteAdditionalMedia(project, media)"
        i18n="@@uploadAdditionalMediaDeleteButtonLabel"
        mat-menu-item
      >
        <mat-icon svgIcon="delete" />
        Delete
      </button>
    </div>
    }
  </ng-template>
</mat-menu>
