<div class="box">
  <audio
    #viewerAudio
    (loadedmetadata)="onAudioLoadMetadata()"
    [volume]="volume$ | ngrxPush"
    [playbackRate]="currentSpeed$ | ngrxPush"
  >
    <source
      *ngIf="project?.media?.video"
      src="{{ project?.media?.video }}"
      type="video/mp4"
    />
  </audio>
  <!--  -->

  <div class="position-relative">
    <div class="loading-spinner" *ngIf="viewerAudio.readyState === 1">
      <mat-spinner mode="indeterminate"></mat-spinner>
    </div>
    <button
      #trigger="matMenuTrigger"
      class="views-menu-button {{ trigger.menuOpen ? 'menu-open' : '' }}"
      mat-button
      [matMenuTriggerFor]="viewsMenu"
    >
      <span>Weitere Ansichten</span> <mat-icon svgIcon="more"></mat-icon>
    </button>

    <mat-menu #viewsMenu="matMenu">
      <div
        class="mat-menu-item-wrapper"
        (click)="onClickMenuItem($event, null)"
        mat-menu-item
      >
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="onChangeViewsMenu($event.checked, null)"
          [checked]="!hiddenVideos.includes('mainVideo')"
          [disabled]="mainVideoId === 'mainVideo'"
        >
          Hauptvideo
        </mat-checkbox>
      </div>

      <div
        class="mat-menu-item-wrapper"
        mat-menu-item
        *ngFor="let video of project?.media?.additionalVideos"
        (click)="onClickMenuItem($event, video)"
      >
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="onChangeViewsMenu($event.checked, video)"
          [checked]="!hiddenVideos.includes(video.id)"
          [disabled]="mainVideoId === video.id"
        >
          {{ video.title }}
        </mat-checkbox>
      </div>
    </mat-menu>

    <div class="video-wrapper" [style.max-height.px]="mainVideoHeight">
      <!-- main video start -->
      <div class="main-video-container" *ngrxLet="bigVideoId$ as bigVideoId">
        <app-video-container
          *ngIf="bigVideoId === 'mainVideo'"
          size="big"
          id="mainVideo"
          url="{{ project?.media?.video }}"
          title="Hauptvideo"
          (videoMetadataLoaded)="resetVideoDimensions()"
        ></app-video-container>

        <ng-container *ngFor="let video of project?.media?.additionalVideos">
          <app-video-container
            *ngIf="video.id === bigVideoId"
            size="big"
            id="{{ video.id }}"
            url="{{ video.url }}"
            title="{{ video.title }}"
            (videoMetadataLoaded)="resetVideoDimensions()"
          ></app-video-container>
        </ng-container>
      </div>
      <!-- main video end -->
      <!-- secondary videos start -->
      <div
        class="secondary-videos"
        [style.width.%]="
          hiddenVideos.length === project?.media?.additionalVideos?.length
            ? 0
            : 100
        "
      >
        <!-- main video as secondary start -->
        <!-- single secondary video start -->

        <app-video-container
          *ngIf="
            !hiddenVideos.includes('mainVideo') && mainVideoId !== 'mainVideo'
          "
          size="small"
          id="main-video"
          url="{{ project?.media?.video }}"
          title="Hauptvideo"
        ></app-video-container>

        <!-- main video as secondary stop -->
        <ng-container *ngFor="let video of project?.media?.additionalVideos">
          <app-video-container
            *ngIf="!hiddenVideos.includes(video.id) && mainVideoId !== video.id"
            size="small"
            id="{{ video.id }}"
            url="{{ video.url }}"
            title="{{ video.title }}"
          ></app-video-container>
        </ng-container>

        <!-- secondary videos end -->
      </div>
    </div>
    <ng-container *ngIf="subtitlesEnabledInVideo$ | ngrxPush">
      <div
        *ngrxLet="combinedCaptionsStyling$ as combined"
        class="viewer-caption {{ combined.position }}"
      >
        <!-- over / under -->
        <span
          *ngrxLet="viewerService.currentCaption$ as currentCaption"
          class="fontsize-{{ combined.fontsize }} color-{{
            combined.color
          }} backgroundColor-{{ combined.backgroundColor }}"
        >
          {{ currentCaption?.text || '-' }}</span
        >
      </div>
    </ng-container>
  </div>

  <app-controls> </app-controls>
</div>
